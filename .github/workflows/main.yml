name: Build Pico 2W MicroPython UF2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PICO_BOARD: pico-w
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y \
            git build-essential cmake ninja-build gcc-arm-none-eabi \
            libnewlib-arm-none-eabi libusb-1.0-0-dev python3-pip

      - name: Clone upstream MicroPython
        run: |
          git clone --depth 1 https://github.com/micropython/micropython.git micropython
          cd micropython
          git submodule update --init

      - name: Patch rp2 port for HID + Bluetooth
        working-directory: micropython/ports/rp2
        run: |
          patch << 'EOF'
          *** Begin Patch
          *** Update File: mpconfigport.h
          @@
          -#define MICROPY_HW_USB_CDC             (1)
          +#define MICROPY_HW_USB_CDC             (1)
          +// Enable USB HID (keyboard + mouse)
          +#define MICROPY_HW_USB_HID             (1)
          +
          +// Enable the Bluetooth API (requires CYW4343x/NimBLE support)
          +#define MICROPY_PY_BLUETOOTH           (1)
          *** End Patch
          EOF

      - name: Build UF2 (release)
        working-directory: micropython/ports/rp2
        run: |
          make submodules
          make BOARD=${PICO_BOARD} BUILD=release

      - name: Collect firmware.uf2
        run: |
          mkdir -p artifacts
          cp micropython/ports/rp2/build/${PICO_BOARD}/firmware.uf2 artifacts/pico2w-custom.uf2

      - name: Upload UF2 artifact
        # pin to a specific minor release so the runner can fetch it
        uses: actions/upload-artifact@v3.1.2
        with:
          name: pico2w-custom.uf2
          path: artifacts/pico2w-custom.uf2
